# 5.å…±äº«æ¨¡å‹ä¹‹å†…å­˜

## 5.1 Java å†…å­˜æ¨¡å‹



JMM å³ **Java Memory Model**ï¼Œå®ƒå®šä¹‰äº†**ä¸»å­˜ï¼ˆå…±äº«ï¼‰ã€å·¥ä½œå†…å­˜(ç§æœ‰)**æŠ½è±¡æ¦‚å¿µï¼Œåº•å±‚å¯¹åº”ç€ **CPU å¯„å­˜å™¨ã€ç¼“å­˜ã€ç¡¬ä»¶å†…å­˜ã€ CPU æŒ‡ä»¤ä¼˜åŒ–ç­‰**ã€‚ 



**JMMçš„æ„ä¹‰**

- è®¡ç®—æœºç¡¬ä»¶åº•å±‚çš„å†…å­˜ç»“æ„è¿‡äºå¤æ‚ï¼ŒJMMçš„æ„ä¹‰åœ¨äº**é¿å…ç¨‹åºå‘˜ç›´æ¥ç®¡ç†è®¡ç®—æœºåº•å±‚å†…å­˜**ï¼Œç”¨ä¸€äº›å…³é”®å­—synchronizedã€volatileç­‰å¯ä»¥**æ–¹ä¾¿çš„ç®¡ç†å†…å­˜**ã€‚



JMM ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ 

- **åŸå­æ€§** - ä¿è¯æŒ‡ä»¤ä¸ä¼šå—åˆ°**çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å½±å“** 
- **å¯è§æ€§** - ä¿è¯æŒ‡ä»¤ä¸ä¼šå— **cpu ç¼“å­˜çš„å½±å“** 
- **æœ‰åºæ€§** - ä¿è¯æŒ‡ä»¤ä¸ä¼šå— **cpu æŒ‡ä»¤å¹¶è¡Œä¼˜åŒ–çš„å½±å“**



## 5.2 å¯è§æ€§ 



#### é€€ä¸å‡ºçš„å¾ªç¯ 

å…ˆæ¥çœ‹ä¸€ä¸ªç°è±¡ï¼Œ**main çº¿ç¨‹å¯¹ run å˜é‡çš„ä¿®æ”¹å¯¹äº t çº¿ç¨‹ä¸å¯è§**ï¼Œå¯¼è‡´äº† t çº¿ç¨‹æ— æ³•åœæ­¢ï¼š

```java
static boolean run = true;
public static void main(String[] args) throws InterruptedException {
    Thread t = new Thread(()->{
        while(run){
            // ....
        }
    });
    t.start();
    sleep(1);
    run = false; // çº¿ç¨‹tä¸ä¼šå¦‚é¢„æƒ³çš„åœä¸‹æ¥
}
```

ä¸ºä»€ä¹ˆå‘¢ï¼Ÿåˆ†æä¸€ä¸‹ï¼š 

1. åˆå§‹çŠ¶æ€ï¼Œ t çº¿ç¨‹åˆšå¼€å§‹ä»ä¸»å†…å­˜**è¯»å–äº† run çš„å€¼åˆ°å·¥ä½œå†…å­˜**ã€‚

![image-20220305192346249](https://typora---------image.oss-cn-beijing.aliyuncs.com/8c5a45bd-18e3-4ce2-bd2e-062cd8652084.png)

2. å› ä¸º t çº¿ç¨‹è¦é¢‘ç¹ä»ä¸»å†…å­˜ä¸­è¯»å– run çš„å€¼ï¼ŒJIT ç¼–è¯‘å™¨ä¼šå°† run çš„å€¼**ç¼“å­˜è‡³è‡ªå·±å·¥ä½œå†…å­˜ä¸­çš„é«˜é€Ÿç¼“å­˜ä¸­**ï¼Œ å‡å°‘å¯¹ä¸»å­˜ä¸­ run çš„è®¿é—®ï¼Œæé«˜æ•ˆç‡

![image-20220305192416102](https://typora---------image.oss-cn-beijing.aliyuncs.com/9d298ce3-96a3-4620-937b-4015f505c502.png)

3. 1 ç§’ä¹‹åï¼Œ**main çº¿ç¨‹ä¿®æ”¹äº† run çš„å€¼**ï¼Œå¹¶**åŒæ­¥è‡³ä¸»å­˜**ï¼Œè€Œ t æ˜¯ä»è‡ªå·±å·¥ä½œå†…å­˜ä¸­çš„**é«˜é€Ÿç¼“å­˜ä¸­è¯»å–è¿™ä¸ªå˜é‡ çš„å€¼**ï¼Œç»“æœæ°¸è¿œæ˜¯æ—§å€¼

![image-20220305192512523](https://typora---------image.oss-cn-beijing.aliyuncs.com/a2d4372e-1324-4107-ba78-70c10ad7d0a3.png)



#### è§£å†³æ–¹æ³• 

**volatile**ï¼ˆæ˜“å˜å…³é”®å­—ï¼‰ 

å®ƒå¯ä»¥ç”¨æ¥ä¿®é¥°**æˆå‘˜å˜é‡å’Œé™æ€æˆå‘˜å˜é‡**ï¼Œä»–å¯ä»¥é¿**å…çº¿ç¨‹ä»è‡ªå·±çš„å·¥ä½œç¼“å­˜ä¸­æŸ¥æ‰¾å˜é‡çš„å€¼**ï¼Œå¿…é¡»åˆ°ä¸»å­˜ä¸­è·å– å®ƒçš„å€¼ï¼Œçº¿ç¨‹æ“ä½œ **volatile å˜é‡éƒ½æ˜¯ç›´æ¥æ“ä½œä¸»å­˜**

â€‹	

synchronized ä¹Ÿå¯ä»¥è§£å†³ï¼Œä½†æ˜¯ä¼šä½¿ç”¨é‡é‡é”ï¼Œæ•ˆç‡ä½

```java
@Slf4j
public class Demo1 {
    volatile static boolean flag = false; // è¿™é‡Œä½¿ç”¨synchronized å¯ä»¥ä¸åœ¨å˜é‡å‰ä¿®é¥°volatile
    final static Object lock = new Object();
    public static void main(String[] args) {
        new Thread( () -> {
            while (true) {
                synchronized (lock) {
                    if ( flag) {
                        break;
                    }
                }
            }
            log.info("end");
        }).start();
        synchronized (lock) {
            flag = true;
        }

    }
}
```

#### å¯è§æ€§ vs åŸå­æ€§ 

å‰é¢ä¾‹å­ä½“ç°çš„å®é™…å°±æ˜¯å¯è§æ€§ï¼Œå®ƒä¿è¯çš„æ˜¯åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´ï¼Œä¸€ä¸ªçº¿ç¨‹å¯¹ **volatile** å˜é‡çš„ä¿®æ”¹å¯¹å¦ä¸€ä¸ªçº¿ç¨‹å¯ è§ï¼Œ ä¸èƒ½ä¿è¯åŸå­æ€§ï¼Œ**ä»…ç”¨åœ¨ä¸€ä¸ªå†™çº¿ç¨‹ï¼Œå¤šä¸ªè¯»çº¿ç¨‹çš„æƒ…å†µ**ï¼š ä¸Šä¾‹ä»å­—èŠ‚ç ç†è§£æ˜¯è¿™æ ·çš„ï¼š

```sh
getstatic run // çº¿ç¨‹ t è·å– run true 
getstatic run // çº¿ç¨‹ t è·å– run true 
getstatic run // çº¿ç¨‹ t è·å– run true 
getstatic run // çº¿ç¨‹ t è·å– run true 
putstatic run // çº¿ç¨‹ main ä¿®æ”¹ run ä¸º falseï¼Œ ä»…æ­¤ä¸€æ¬¡
getstatic run // çº¿ç¨‹ t è·å– run false 
```

æ¯”è¾ƒä¸€ä¸‹ä¹‹å‰æˆ‘ä»¬å°†çº¿ç¨‹å®‰å…¨æ—¶ä¸¾çš„ä¾‹å­ï¼šä¸¤ä¸ªçº¿ç¨‹ä¸€ä¸ª i++ ä¸€ä¸ª i-- ï¼Œåªèƒ½ä¿è¯çœ‹åˆ°æœ€æ–°å€¼ï¼Œä¸èƒ½è§£å†³æŒ‡ä»¤äº¤é”™

```sh
// å‡è®¾içš„åˆå§‹å€¼ä¸º0 
getstatic i // çº¿ç¨‹2-è·å–é™æ€å˜é‡içš„å€¼ çº¿ç¨‹å†…i=0 
getstatic i // çº¿ç¨‹1-è·å–é™æ€å˜é‡içš„å€¼ çº¿ç¨‹å†…i=0 
iconst_1 // çº¿ç¨‹1-å‡†å¤‡å¸¸é‡1 
iadd // çº¿ç¨‹1-è‡ªå¢ çº¿ç¨‹å†…i=1 
putstatic i // çº¿ç¨‹1-å°†ä¿®æ”¹åçš„å€¼å­˜å…¥é™æ€å˜é‡i é™æ€å˜é‡i=1 
iconst_1 // çº¿ç¨‹2-å‡†å¤‡å¸¸é‡1 
isub // çº¿ç¨‹2-è‡ªå‡ çº¿ç¨‹å†…i=-1 
putstatic i // çº¿ç¨‹2-å°†ä¿®æ”¹åçš„å€¼å­˜å…¥é™æ€å˜é‡i é™æ€å˜é‡i=-1 
```

> **æ³¨æ„** 
>
> synchronized è¯­å¥å—æ—¢å¯ä»¥ä¿è¯ä»£ç å—çš„**åŸå­æ€§**ï¼Œä¹ŸåŒæ—¶ä¿è¯ä»£ç å—å†…å˜é‡çš„**å¯è§æ€§**ã€‚ä½†ç¼ºç‚¹æ˜¯ synchronized æ˜¯å±äº**é‡é‡çº§æ“ä½œï¼Œæ€§èƒ½ç›¸å¯¹æ›´ä½** ã€‚
>
> JMMå…³äºsynchronizedçš„ä¸¤æ¡è§„å®šï¼š
>
> ã€€ã€€1ï¼‰çº¿ç¨‹è§£é”å‰ï¼Œå¿…é¡»æŠŠ**å…±äº«å˜é‡çš„æœ€æ–°å€¼åˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­**
>
> ã€€ã€€2ï¼‰çº¿ç¨‹åŠ é”æ—¶ï¼Œå°†**æ¸…ç©ºå·¥ä½œå†…å­˜ä¸­å…±äº«å˜é‡çš„å€¼**ï¼Œä»è€Œä½¿ç”¨å…±äº«å˜é‡æ—¶éœ€è¦**ä»ä¸»å†…å­˜ä¸­é‡æ–°è·å–æœ€æ–°çš„å€¼**
>
> ã€€ã€€ã€€ï¼ˆæ³¨æ„ï¼šåŠ é”ä¸è§£é”éœ€è¦æ˜¯åŒä¸€æŠŠé”ï¼‰
>
> é€šè¿‡ä»¥ä¸Šä¸¤ç‚¹ï¼Œå¯ä»¥çœ‹åˆ°synchronizedèƒ½å¤Ÿå®ç°å¯è§æ€§ã€‚åŒæ—¶ï¼Œç”±äºsynchronizedå…·æœ‰åŒæ­¥é”ï¼Œæ‰€ä»¥å®ƒä¹Ÿå…·æœ‰åŸå­æ€§
>
> å¦‚æœåœ¨å‰é¢ç¤ºä¾‹çš„æ­»å¾ªç¯ä¸­åŠ å…¥ System.out.println() ä¼šå‘ç°å³ä½¿ä¸åŠ  volatile ä¿®é¥°ç¬¦ï¼Œçº¿ç¨‹ t ä¹Ÿèƒ½æ­£ç¡®çœ‹åˆ° å¯¹ run å˜é‡çš„ä¿®æ”¹äº†ï¼Œæƒ³ä¸€æƒ³ä¸ºä»€ä¹ˆï¼Ÿ(printlnæ–¹æ³•ä¸­æœ‰synchronizedä»£ç å—ä¿è¯äº†å¯è§æ€§)
>
> synchronizedå…³é”®å­—**ä¸èƒ½é˜»æ­¢æŒ‡ä»¤é‡æ’ï¼Œä½†åœ¨ä¸€å®šç¨‹åº¦ä¸Šèƒ½ä¿è¯æœ‰åºæ€§**ï¼ˆå¦‚æœå…±äº«å˜é‡æ²¡æœ‰é€ƒé€¸å‡ºåŒæ­¥ä»£ç å—çš„è¯ï¼‰ã€‚å› ä¸ºåœ¨å•çº¿ç¨‹çš„æƒ…å†µä¸‹**æŒ‡ä»¤é‡æ’ä¸å½±å“ç»“æœï¼Œç›¸å½“äºä¿éšœäº†æœ‰åºæ€§ã€‚**

 

#### <font color='orange'>æ¨¡å¼ä¹‹ä¸¤é˜¶æ®µç»ˆæ­¢</font>



Two Phase Termination 

åœ¨ä¸€ä¸ªçº¿ç¨‹ T1 ä¸­å¦‚ä½•â€œä¼˜é›…â€ç»ˆæ­¢çº¿ç¨‹ T2ï¼Ÿè¿™é‡Œçš„ã€ä¼˜é›…ã€‘æŒ‡çš„æ˜¯ç»™ T2 ä¸€ä¸ªæ–™ç†åäº‹çš„æœºä¼šã€‚



##### 1.é”™è¯¯æ€è·¯ 

- ä½¿ç”¨çº¿ç¨‹å¯¹è±¡çš„ stop() æ–¹æ³•åœæ­¢çº¿ç¨‹ 
  - stop æ–¹æ³•ä¼šçœŸæ­£æ€æ­»çº¿ç¨‹ï¼Œå¦‚æœè¿™æ—¶çº¿ç¨‹é”ä½äº†å…±äº«èµ„æºï¼Œé‚£ä¹ˆå½“å®ƒè¢«æ€æ­»åå°±å†ä¹Ÿæ²¡æœ‰æœºä¼šé‡Šæ”¾é”ï¼Œ å…¶å®ƒçº¿ç¨‹å°†æ°¸è¿œæ— æ³•è·å–é” 
- ä½¿ç”¨ System.exit(int) æ–¹æ³•åœæ­¢çº¿ç¨‹ 
  - ç›®çš„ä»…æ˜¯åœæ­¢ä¸€ä¸ªçº¿ç¨‹ï¼Œä½†è¿™ç§åšæ³•ä¼šè®©æ•´ä¸ªç¨‹åºéƒ½åœæ­¢



##### 2.ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼

![image-20220305211507893](https://typora---------image.oss-cn-beijing.aliyuncs.com/502df1bc-0c14-465f-8cf9-5ebd6bbad194.png)

**åˆ©ç”¨ isInterrupted**

interrupt å¯ä»¥æ‰“æ–­æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹ï¼Œæ— è®ºè¿™ä¸ªçº¿ç¨‹æ˜¯åœ¨ sleepï¼Œwaitï¼Œè¿˜æ˜¯æ­£å¸¸è¿è¡Œ

```java
class TPTInterrupt {
    private Thread thread;
    public void start(){
        thread = new Thread(() -> {
            while(true) {
                Thread current = Thread.currentThread();
                if(current.isInterrupted()) {
                    log.debug("æ–™ç†åäº‹");
                    break;
                }
                try {
                    Thread.sleep(1000);
                    log.debug("å°†ç»“æœä¿å­˜");
                } catch (InterruptedException e) {
                    //æ‰“æ–­sleepçº¿ç¨‹ä¼šæ¸…é™¤æ‰“æ–­æ ‡è®°ï¼Œæ‰€ä»¥è¦æ·»åŠ æ ‡è®°
                    current.interrupt();
                }
                // æ‰§è¡Œç›‘æ§æ“ä½œ 
            }
        },"ç›‘æ§çº¿ç¨‹");
        thread.start();
    }
    public void stop() {
        thread.interrupt();
    }
}
```

è°ƒç”¨

```java
TPTInterrupt t = new TPTInterrupt();
t.start();
Thread.sleep(3500);
log.debug("stop");
t.stop();
```

ç»“æœ

```sh
11:49:42.915 c.TwoPhaseTermination [ç›‘æ§çº¿ç¨‹] - å°†ç»“æœä¿å­˜
11:49:43.919 c.TwoPhaseTermination [ç›‘æ§çº¿ç¨‹] - å°†ç»“æœä¿å­˜
11:49:44.919 c.TwoPhaseTermination [ç›‘æ§çº¿ç¨‹] - å°†ç»“æœä¿å­˜
11:49:45.413 c.TestTwoPhaseTermination [main] - stop 
11:49:45.413 c.TwoPhaseTermination [ç›‘æ§çº¿ç¨‹] - æ–™ç†åäº‹
```

##### åˆ©ç”¨volatileä¿®é¥°çš„åœæ­¢æ ‡è®°

```java
// åœæ­¢æ ‡è®°ç”¨ volatile æ˜¯ä¸ºäº†ä¿è¯è¯¥å˜é‡åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´çš„å¯è§æ€§
// æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œå³ä¸»çº¿ç¨‹æŠŠå®ƒä¿®æ”¹ä¸º true å¯¹ t1 çº¿ç¨‹å¯è§
class TPTVolatile {
    private Thread thread;
    private volatile boolean stop = false;
    public void start(){
        thread = new Thread(() -> {
            while(true) {
                Thread current = Thread.currentThread();
                if(stop) {
                    log.debug("æ–™ç†åäº‹");
                    break;
                }
                try {
                    Thread.sleep(1000);
                    log.debug("å°†ç»“æœä¿å­˜");
                } catch (InterruptedException e) {
                     }
                // æ‰§è¡Œç›‘æ§æ“ä½œ
            }
        },"ç›‘æ§çº¿ç¨‹");
        thread.start();
    }
    public void stop() {
        stop = true;
        //è®©çº¿ç¨‹ç«‹å³åœæ­¢è€Œä¸æ˜¯ç­‰å¾…sleepç»“æŸ
        thread.interrupt();
    }
}
```

è°ƒç”¨

```java
TPTVolatile t = new TPTVolatile();
t.start();
Thread.sleep(3500);
log.debug("stop");
t.stop();
```

ç»“æœ

```sh
11:54:52.003 c.TPTVolatile [ç›‘æ§çº¿ç¨‹] - å°†ç»“æœä¿å­˜
11:54:53.006 c.TPTVolatile [ç›‘æ§çº¿ç¨‹] - å°†ç»“æœä¿å­˜
11:54:54.007 c.TPTVolatile [ç›‘æ§çº¿ç¨‹] - å°†ç»“æœä¿å­˜
11:54:54.502 c.TestTwoPhaseTermination [main] - stop 
11:54:54.502 c.TPTVolatile [ç›‘æ§çº¿ç¨‹] - æ–™ç†åäº‹
```



#### <font color='orange'>æ¨¡å¼ä¹‹ Balking</font>



##### 1.å®šä¹‰ 

Balking ï¼ˆçŠ¹è±«ï¼‰æ¨¡å¼ç”¨åœ¨**ä¸€ä¸ªçº¿ç¨‹å‘ç°å¦ä¸€ä¸ªçº¿ç¨‹æˆ–æœ¬çº¿ç¨‹å·²ç»åšäº†æŸä¸€ä»¶ç›¸åŒçš„äº‹**ï¼Œé‚£ä¹ˆæœ¬çº¿ç¨‹å°±æ— éœ€å†åš äº†ï¼Œç›´æ¥ç»“æŸè¿”å›



##### 2.å®ç° 

ä¾‹å¦‚ï¼š

```java
public class MonitorService {
    // ç”¨æ¥è¡¨ç¤ºæ˜¯å¦å·²ç»æœ‰çº¿ç¨‹å·²ç»åœ¨æ‰§è¡Œå¯åŠ¨äº†
    private volatile boolean starting;
    public void start() {
        log.info("å°è¯•å¯åŠ¨ç›‘æ§çº¿ç¨‹...");
        synchronized (this) { //ä½¿ç”¨åŒæ­¥ä»£ç å—ï¼Œé˜²æ­¢åœ¨æ ‡å¿—ä¿®æ”¹å‰ï¼Œå°±æœ‰çº¿ç¨‹åˆ°äº†åˆ¤æ–­çš„åé¢ä¸€æ­¥
            if (starting) {
                return;
            }
            starting = true;
        }
		//å…¶å®synchronizedå¤–é¢è¿˜å¯ä»¥å†å¥—ä¸€å±‚ifï¼Œæˆ–è€…æ”¹ä¸ºif(!starting)ï¼Œifæ¡†åç›´æ¥return
        // çœŸæ­£å¯åŠ¨ç›‘æ§çº¿ç¨‹...
    }
}
```

å½“å‰ç«¯é¡µé¢å¤šæ¬¡ç‚¹å‡»æŒ‰é’®è°ƒç”¨ start æ—¶ 

è¾“å‡º

```java
[http-nio-8080-exec-1] cn.itcast.monitor.service.MonitorService - è¯¥ç›‘æ§çº¿ç¨‹å·²å¯åŠ¨?(false)
[http-nio-8080-exec-1] cn.itcast.monitor.service.MonitorService - ç›‘æ§çº¿ç¨‹å·²å¯åŠ¨...
[http-nio-8080-exec-2] cn.itcast.monitor.service.MonitorService - è¯¥ç›‘æ§çº¿ç¨‹å·²å¯åŠ¨?(true)
[http-nio-8080-exec-3] cn.itcast.monitor.service.MonitorService - è¯¥ç›‘æ§çº¿ç¨‹å·²å¯åŠ¨?(true)
[http-nio-8080-exec-4] cn.itcast.monitor.service.MonitorService - è¯¥ç›‘æ§çº¿ç¨‹å·²å¯åŠ¨?(true)
```

å®ƒè¿˜ç»å¸¸ç”¨æ¥å®ç°çº¿ç¨‹å®‰å…¨çš„å•ä¾‹

```java
public final class Singleton {
    
    private Singleton() {
    }
    
    private static Singleton INSTANCE = null;
    
    public static synchronized Singleton getInstance() { // ä½¿ç”¨synchronized ï¼Œä¿è¯å¯è§æ€§ï¼Œé˜²æ­¢å¯¹è±¡å¤šæ¬¡è¢«åˆ›å»º
        if (INSTANCE != null) {
            return INSTANCE;
        }
        INSTANCE = new Singleton();
        return INSTANCE;
    }
}
```

å¯¹æ¯”ä¸€ä¸‹ä¿æŠ¤æ€§æš‚åœæ¨¡å¼ï¼šä¿æŠ¤æ€§æš‚åœæ¨¡å¼ç”¨åœ¨ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹çš„æ‰§è¡Œç»“æœï¼Œå½“æ¡ä»¶ä¸æ»¡è¶³æ—¶çº¿ç¨‹ç­‰å¾…ã€‚



## 5.3 æœ‰åºæ€§ 



JVM ä¼šåœ¨ä¸å½±å“æ­£ç¡®æ€§çš„å‰æä¸‹ï¼Œå¯ä»¥è°ƒæ•´è¯­å¥çš„æ‰§è¡Œé¡ºåºï¼Œæ€è€ƒä¸‹é¢ä¸€æ®µä»£ç 

```java
static int i;
static int j;
// åœ¨æŸä¸ªçº¿ç¨‹å†…æ‰§è¡Œå¦‚ä¸‹èµ‹å€¼æ“ä½œ
i = ...; 
j = ...; 
```

å¯ä»¥çœ‹åˆ°ï¼Œè‡³äºæ˜¯å…ˆæ‰§è¡Œ i è¿˜æ˜¯ å…ˆæ‰§è¡Œ j ï¼Œå¯¹æœ€ç»ˆçš„ç»“æœä¸ä¼šäº§ç”Ÿå½±å“ã€‚æ‰€ä»¥ï¼Œä¸Šé¢ä»£ç çœŸæ­£æ‰§è¡Œæ—¶ï¼Œæ—¢å¯ä»¥æ˜¯

```java
i = ...; 
j = ...;
```

ä¹Ÿå¯ä»¥æ˜¯

```java
j = ...;
i = ...; 
```

è¿™ç§ç‰¹æ€§ç§°ä¹‹ä¸ºã€æŒ‡ä»¤é‡æ’ã€ï¼Œå¤šçº¿ç¨‹ä¸‹ã€æŒ‡ä»¤é‡æ’ã€ä¼šå½±å“æ­£ç¡®æ€§ã€‚ä¸ºä»€ä¹ˆè¦æœ‰é‡æ’æŒ‡ä»¤è¿™é¡¹ä¼˜åŒ–å‘¢ï¼Ÿä» CPU æ‰§è¡ŒæŒ‡ä»¤çš„åŸç†æ¥ç†è§£ä¸€ä¸‹å§



#### <font color='blue'>åŸç†ä¹‹æŒ‡ä»¤çº§å¹¶è¡Œ</font>



##### åè¯ 



**Clock Cycle Time** 

**ä¸»é¢‘**çš„æ¦‚å¿µå¤§å®¶æ¥è§¦çš„æ¯”è¾ƒå¤šï¼Œè€Œ CPU çš„ Clock Cycle Timeï¼ˆæ—¶é’Ÿå‘¨æœŸæ—¶é—´ï¼‰ï¼Œç­‰äºä¸»é¢‘çš„å€’æ•°ï¼Œæ„æ€æ˜¯ **CPU èƒ½ å¤Ÿè¯†åˆ«çš„æœ€å°æ—¶é—´å•ä½**ï¼Œæ¯”å¦‚è¯´ 4G ä¸»é¢‘çš„ CPU çš„ Clock Cycle Time å°±æ˜¯ 0.25 nsï¼Œä½œä¸ºå¯¹æ¯”ï¼Œæˆ‘ä»¬å¢™ä¸ŠæŒ‚é’Ÿçš„ Cycle Time æ˜¯ 1s 

ä¾‹å¦‚ï¼Œ**è¿è¡Œä¸€æ¡åŠ æ³•æŒ‡ä»¤ä¸€èˆ¬éœ€è¦ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸæ—¶é—´** 



**CPI** 

æœ‰çš„æŒ‡ä»¤éœ€è¦æ›´å¤šçš„æ—¶é’Ÿå‘¨æœŸæ—¶é—´ï¼Œæ‰€ä»¥å¼•å‡ºäº† **CPI** ï¼ˆCycles Per Instructionï¼‰**æŒ‡ä»¤å¹³å‡æ—¶é’Ÿå‘¨æœŸæ•°** 



**IPC** 

IPCï¼ˆInstruction Per Clock Cycleï¼‰ **å³ CPI çš„å€’æ•°**ï¼Œè¡¨ç¤º**æ¯ä¸ªæ—¶é’Ÿå‘¨æœŸèƒ½å¤Ÿè¿è¡Œçš„æŒ‡ä»¤æ•°** 



**CPU æ‰§è¡Œæ—¶é—´** 

ç¨‹åºçš„ CPU æ‰§è¡Œæ—¶é—´ï¼Œå³æˆ‘ä»¬å‰é¢æåˆ°çš„ user + system æ—¶é—´ï¼Œå¯ä»¥ç”¨ä¸‹é¢çš„å…¬å¼æ¥è¡¨ç¤º

```java
ç¨‹åº CPU æ‰§è¡Œæ—¶é—´ = æŒ‡ä»¤æ•° * CPI * Clock Cycle Time
```



##### æŒ‡ä»¤é‡æ’åºä¼˜åŒ–

äº‹å®ä¸Šï¼Œç°ä»£å¤„ç†å™¨ä¼šè®¾è®¡ä¸º**ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸå®Œæˆä¸€æ¡æ‰§è¡Œæ—¶é—´æœ€é•¿çš„ CPU æŒ‡ä»¤**ã€‚ä¸ºä»€ä¹ˆè¿™ä¹ˆåšå‘¢ï¼Ÿå¯ä»¥æƒ³åˆ°æŒ‡ä»¤ è¿˜å¯ä»¥å†åˆ’åˆ†æˆä¸€ä¸ªä¸ªæ›´å°çš„é˜¶æ®µï¼Œä¾‹å¦‚ï¼Œæ¯æ¡æŒ‡ä»¤éƒ½å¯ä»¥åˆ†ä¸ºï¼š **`å–æŒ‡ä»¤ - æŒ‡ä»¤è¯‘ç  - æ‰§è¡ŒæŒ‡ä»¤ - å†…å­˜è®¿é—® - æ•°æ®å†™å›`** è¿™ 5 ä¸ªé˜¶æ®µ

![image-20220306122605032](https://typora---------image.oss-cn-beijing.aliyuncs.com/67e30f60-0d08-40e6-8505-ce134a0d5708.png)

> **æœ¯è¯­å‚è€ƒ**ï¼š 
>
> - instruction fetch (IF) 
> - instruction decode (ID) 
> - execute (EX) 
> - memory access (MEM) 
> - register write back (WB)

åœ¨ä¸æ”¹å˜ç¨‹åºç»“æœçš„å‰æä¸‹ï¼Œè¿™äº›æŒ‡ä»¤çš„å„ä¸ªé˜¶æ®µå¯ä»¥é€šè¿‡**é‡æ’åº**å’Œ**ç»„åˆ**æ¥å®ç°æŒ‡ä»¤çº§å¹¶è¡Œï¼Œè¿™ä¸€æŠ€æœ¯åœ¨ 80's ä¸­ å¶åˆ° 90's ä¸­å¶å æ®äº†è®¡ç®—æ¶æ„çš„é‡è¦åœ°ä½ã€‚

> **æç¤º**ï¼š 
>
> åˆ†é˜¶æ®µï¼Œåˆ†å·¥æ˜¯æå‡æ•ˆç‡çš„å…³é”®ï¼

æŒ‡ä»¤é‡æ’çš„å‰ææ˜¯ï¼Œ**é‡æ’æŒ‡ä»¤ä¸èƒ½å½±å“ç»“æœ**ï¼Œä¾‹å¦‚

```java
// å¯ä»¥é‡æ’çš„ä¾‹å­
int a = 10; // æŒ‡ä»¤1
int b = 20; // æŒ‡ä»¤2
System.out.println( a + b );
// ä¸èƒ½é‡æ’çš„ä¾‹å­
int a = 10; // æŒ‡ä»¤1
int b = a - 5; // æŒ‡ä»¤2
```

> **å‚è€ƒ**ï¼š 
>
> [Scoreboarding](https://en.wikipedia.org/wiki/Scoreboarding) and the [Tomasulo algorithm](https://en.wikipedia.org/wiki/Tomasulo_algorithm) (which is similar to scoreboarding but makes use of [register renaming](https://en.wikipedia.org/wiki/Register_renaming) )are two of the most common techniques for implementing out-of-order execution and instruction-level parallelism.



##### æ”¯æŒæµæ°´çº¿çš„å¤„ç†å™¨

ç°ä»£ CPU æ”¯æŒ**å¤šçº§æŒ‡ä»¤æµæ°´çº¿**ï¼Œä¾‹å¦‚æ”¯æŒåŒæ—¶æ‰§è¡Œ `å–æŒ‡ä»¤ - æŒ‡ä»¤è¯‘ç  - æ‰§è¡ŒæŒ‡ä»¤ - å†…å­˜è®¿é—® - æ•°æ®å†™å›` çš„å¤„ç† å™¨ï¼Œå°±å¯ä»¥ç§°ä¹‹ä¸º**äº”çº§æŒ‡ä»¤æµæ°´çº¿**ã€‚**è¿™æ—¶ CPU å¯ä»¥åœ¨ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸå†…ï¼ŒåŒæ—¶è¿è¡Œäº”æ¡æŒ‡ä»¤çš„ä¸åŒé˜¶æ®µ**ï¼ˆç›¸å½“äºä¸€ æ¡æ‰§è¡Œæ—¶é—´æœ€é•¿çš„å¤æ‚æŒ‡ä»¤ï¼‰ï¼ŒIPC = 1ï¼Œæœ¬è´¨ä¸Šï¼Œæµæ°´çº¿æŠ€æœ¯**å¹¶ä¸èƒ½ç¼©çŸ­å•æ¡æŒ‡ä»¤çš„æ‰§è¡Œæ—¶é—´**ï¼Œä½†å®ƒå˜ç›¸åœ°**æé«˜äº† æŒ‡ä»¤åœ°ååç‡ã€‚**

> **æç¤º**ï¼š 
>
> å¥”è…¾å››ï¼ˆPentium 4ï¼‰æ”¯æŒé«˜è¾¾ 35 çº§æµæ°´çº¿ï¼Œä½†ç”±äºåŠŸè€—å¤ªé«˜è¢«åºŸå¼ƒ

![image-20220306123819512](https://typora---------image.oss-cn-beijing.aliyuncs.com/183da9e9-cdcb-48dd-845c-ff7f34918d39.png)



##### SuperScalar å¤„ç†å™¨

å¤§å¤šæ•°å¤„ç†å™¨åŒ…å«å¤šä¸ªæ‰§è¡Œå•å…ƒï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰è®¡ç®—åŠŸèƒ½éƒ½é›†ä¸­åœ¨ä¸€èµ·ï¼Œå¯ä»¥å†ç»†åˆ†ä¸ºæ•´æ•°è¿ç®—å•å…ƒã€æµ®ç‚¹æ•°è¿ç®—å• å…ƒç­‰ï¼Œ**è¿™æ ·å¯ä»¥æŠŠå¤šæ¡æŒ‡ä»¤ä¹Ÿå¯ä»¥åšåˆ°å¹¶è¡Œè·å–ã€è¯‘ç ç­‰**ï¼ŒCPU å¯ä»¥åœ¨ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸå†…ï¼Œæ‰§è¡Œå¤šäºä¸€æ¡æŒ‡ä»¤ï¼ŒIPC > 1

![image-20220306123933327](https://typora---------image.oss-cn-beijing.aliyuncs.com/325f8b75-c010-401e-a054-1da1b478cf98.png)





#### è¯¡å¼‚çš„ç»“æœ

```java
int num = 0;
boolean ready = false;
// çº¿ç¨‹1 æ‰§è¡Œæ­¤æ–¹æ³•
public void actor1(I_Result r) {
    if(ready) {
        r.r1 = num + num;
    } else {
        r.r1 = 1;
    }
}
// çº¿ç¨‹2 æ‰§è¡Œæ­¤æ–¹æ³•
public void actor2(I_Result r) { 
    num = 2;
    ready = true; 
}
```

I_Result æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œæœ‰ä¸€ä¸ªå±æ€§ r1 ç”¨æ¥ä¿å­˜ç»“æœï¼Œé—®ï¼Œå¯èƒ½çš„ç»“æœæœ‰å‡ ç§ï¼Ÿ 

æœ‰åŒå­¦è¿™ä¹ˆåˆ†æ 

æƒ…å†µ1ï¼šçº¿ç¨‹1 å…ˆæ‰§è¡Œï¼Œè¿™æ—¶ ready = falseï¼Œæ‰€ä»¥è¿›å…¥ else åˆ†æ”¯ç»“æœä¸º 1 

æƒ…å†µ2ï¼šçº¿ç¨‹2 å…ˆæ‰§è¡Œ num = 2ï¼Œä½†æ²¡æ¥å¾—åŠæ‰§è¡Œ ready = trueï¼Œçº¿ç¨‹1 æ‰§è¡Œï¼Œè¿˜æ˜¯è¿›å…¥ else åˆ†æ”¯ï¼Œç»“æœä¸º1 

æƒ…å†µ3ï¼šçº¿ç¨‹2 æ‰§è¡Œåˆ° ready = trueï¼Œçº¿ç¨‹1 æ‰§è¡Œï¼Œè¿™å›è¿›å…¥ if åˆ†æ”¯ï¼Œç»“æœä¸º 4ï¼ˆå› ä¸º num å·²ç»æ‰§è¡Œè¿‡äº†ï¼‰



ä½†æˆ‘å‘Šè¯‰ä½ ï¼Œç»“æœè¿˜æœ‰å¯èƒ½æ˜¯ 0 ğŸ˜ğŸ˜ğŸ˜ï¼Œä¿¡ä¸ä¿¡å§ï¼ 

è¿™ç§æƒ…å†µä¸‹æ˜¯ï¼š**çº¿ç¨‹2 æ‰§è¡Œ ready = trueï¼Œåˆ‡æ¢åˆ°çº¿ç¨‹1ï¼Œè¿›å…¥ if åˆ†æ”¯ï¼Œç›¸åŠ ä¸º 0**ï¼Œå†åˆ‡å›çº¿ç¨‹2 æ‰§è¡Œ num = 2 

ç›¸ä¿¡å¾ˆå¤šäººå·²ç»æ™•äº† ğŸ˜µğŸ˜µğŸ˜µ



è¿™ç§ç°è±¡å«åš**æŒ‡ä»¤é‡æ’**ï¼Œæ˜¯ JIT ç¼–è¯‘å™¨åœ¨è¿è¡Œæ—¶çš„ä¸€äº›ä¼˜åŒ–ï¼Œè¿™ä¸ªç°è±¡**éœ€è¦é€šè¿‡å¤§é‡æµ‹è¯•**æ‰èƒ½å¤ç°ï¼š 

å€ŸåŠ© java å¹¶å‘å‹æµ‹å·¥å…· jcstress https://wiki.openjdk.java.net/display/CodeTools/jcstress

```sh
mvn archetype:generate -DinteractiveMode=false -DarchetypeGroupId=org.openjdk.jcstress -
DarchetypeArtifactId=jcstress-java-test-archetype -DarchetypeVersion=0.5 -DgroupId=cn.itcast -
DartifactId=ordering -Dversion=1.0 
```

åˆ›å»º maven é¡¹ç›®ï¼Œæä¾›å¦‚ä¸‹æµ‹è¯•ç±»

```java
@JCStressTest
@Outcome(id = {"1", "4"}, expect = Expect.ACCEPTABLE, desc = "ok")
@Outcome(id = "0", expect = Expect.ACCEPTABLE_INTERESTING, desc = "!!!!")
@State
public class ConcurrencyTest {
    int num = 0;
    boolean ready = false;
    @Actor
    public void actor1(I_Result r) {
        if(ready) {
            r.r1 = num + num;
        } else {
            r.r1 = 1;
        }
    }
    @Actor
    public void actor2(I_Result r) {
        num = 2;
        ready = true;
    }
}
```

æ‰§è¡Œ

```sh
mvn clean install 
java -jar target/jcstress.jar 
```

ä¼šè¾“å‡ºæˆ‘ä»¬æ„Ÿå…´è¶£çš„ç»“æœï¼Œæ‘˜å½•å…¶ä¸­ä¸€æ¬¡ç»“æœï¼š

```sh
*** INTERESTING tests 
 Some interesting behaviors observed. This is for the plain curiosity. 
 
 2 matching test results. 
 	[OK] test.ConcurrencyTest 
 	(JVM args: [-XX:-TieredCompilation]) 
    Observed state 	Occurrences 	Expectation Interpretation 
    0 				1,729 			ACCEPTABLE_INTERESTING !!!! 
 	1 				42,617,915 		ACCEPTABLE ok 
 	4 				5,146,627 		ACCEPTABLE ok 
 
 	[OK] test.ConcurrencyTest 
 	(JVM args: []) 
 	Observed state 	Occurrences 	Expectation Interpretation 
 	0 				1,652 			ACCEPTABLE_INTERESTING !!!! 
 	1 				46,460,657 		ACCEPTABLE ok 
 	4 				4,571,072 		ACCEPTABLE ok 
```

å¯ä»¥çœ‹åˆ°ï¼Œå‡ºç°ç»“æœä¸º 0 çš„æƒ…å†µæœ‰ 638 æ¬¡ï¼Œè™½ç„¶æ¬¡æ•°ç›¸å¯¹å¾ˆå°‘ï¼Œä½†æ¯•ç«Ÿæ˜¯å‡ºç°äº†ã€‚



#### è§£å†³æ–¹æ³• 

volatile ä¿®é¥°çš„å˜é‡ï¼Œå¯ä»¥**ç¦ç”¨æŒ‡ä»¤é‡æ’**

```java
@JCStressTest
@Outcome(id = {"1", "4"}, expect = Expect.ACCEPTABLE, desc = "ok")
@Outcome(id = "0", expect = Expect.ACCEPTABLE_INTERESTING, desc = "!!!!")
@State
public class ConcurrencyTest {
    int num = 0;
    volatile boolean ready = false;
    @Actor
    public void actor1(I_Result r) {
        if(ready) {
            r.r1 = num + num;
        } else {
            r.r1 = 1;
        }
    }
    @Actor
    public void actor2(I_Result r) {
        num = 2;
        ready = true; //readyä»¥ä¸Šçš„ä»£ç è¢«é˜²æ­¢äº†é‡æ’åº
    }
}
```

ç»“æœä¸ºï¼š

```sh
*** INTERESTING tests 
 Some interesting behaviors observed. This is for the plain curiosity. 
 0 matching test results. 
```



#### <font color='blue'>åŸç†ä¹‹ volatile</font>

**volatile** çš„åº•å±‚å®ç°åŸç†æ˜¯**å†…å­˜å±éšœ**ï¼Œ**Memory Barrier**ï¼ˆMemory Fenceï¼‰ 

- å¯¹ volatile å˜é‡çš„**å†™æŒ‡ä»¤å**ä¼šåŠ å…¥**å†™å±éšœ** 
- å¯¹ volatile å˜é‡çš„**è¯»æŒ‡ä»¤å‰**ä¼šåŠ å…¥**è¯»å±éšœ**



##### å¦‚ä½•ä¿è¯å¯è§æ€§

- å†™å±éšœï¼ˆsfenceï¼‰ä¿è¯åœ¨è¯¥**å±éšœä¹‹å‰**çš„ï¼Œ**å¯¹å…±äº«å˜é‡çš„æ”¹åŠ¨ï¼Œéƒ½åŒæ­¥åˆ°ä¸»å­˜å½“ä¸­**

- ```java
  public void actor2(I_Result r) {
      num = 2;
      ready = true; // ready æ˜¯ volatile èµ‹å€¼å¸¦å†™å±éšœ
      // å†™å±éšœ
  }
  ```

- è€Œè¯»å±éšœï¼ˆlfenceï¼‰ä¿è¯åœ¨è¯¥**å±éšœä¹‹å**ï¼Œå¯¹å…±äº«å˜é‡çš„è¯»å–ï¼Œ**åŠ è½½çš„æ˜¯ä¸»å­˜ä¸­æœ€æ–°æ•°æ®**

- ```java
  public void actor1(I_Result r) {
      // è¯»å±éšœ
      // ready æ˜¯ volatile è¯»å–å€¼å¸¦è¯»å±éšœ
      if(ready) {
          r.r1 = num + num;
      } else {
          r.r1 = 1;
      }
  }
  ```

- ![image-20220306125622336](https://typora---------image.oss-cn-beijing.aliyuncs.com/856c906a-2fb6-4766-b68f-7329b7c36860.png)



##### å¦‚ä½•ä¿è¯æœ‰åºæ€§

- å†™å±éšœä¼šç¡®ä¿**æŒ‡ä»¤é‡æ’åºæ—¶**ï¼Œ**ä¸ä¼šå°†å†™å±éšœä¹‹å‰çš„ä»£ç æ’åœ¨å†™å±éšœä¹‹å**

- ```java
  public void actor2(I_Result r) {
      num = 2;
      ready = true; // ready æ˜¯ volatile èµ‹å€¼å¸¦å†™å±éšœ
      // å†™å±éšœ
  }
  ```

- è¯»å±éšœä¼šç¡®ä¿**æŒ‡ä»¤é‡æ’åºæ—¶**ï¼Œä¸ä¼šå°†**è¯»å±éšœä¹‹åçš„ä»£ç æ’åœ¨è¯»å±éšœä¹‹å‰**

- ```java
  public void actor1(I_Result r) {
      // è¯»å±éšœ
      // ready æ˜¯ volatile è¯»å–å€¼å¸¦è¯»å±éšœ
      if(ready) {
          r.r1 = num + num;
      } else {
          r.r1 = 1;
      }
  }
  ```

- ![image-20220306130348150](https://typora---------image.oss-cn-beijing.aliyuncs.com/276f5b3f-fafa-4283-91cc-63bf2e43f5e8.png)

è¿˜æ˜¯é‚£å¥è¯ï¼Œ**ä¸èƒ½è§£å†³æŒ‡ä»¤äº¤é”™**ï¼š 

- å†™å±éšœä»…ä»…æ˜¯ä¿è¯ä¹‹åçš„**è¯»èƒ½å¤Ÿè¯»åˆ°æœ€æ–°çš„ç»“æœ**ï¼Œä½†**ä¸èƒ½ä¿è¯è¯»è·‘åˆ°å®ƒå‰é¢å»** 
- è€Œ**æœ‰åºæ€§**çš„ä¿è¯ä¹Ÿåªæ˜¯ä¿è¯äº†**æœ¬çº¿ç¨‹å†…ç›¸å…³ä»£ç ä¸è¢«é‡æ’åº**

![image-20220306130731767](https://typora---------image.oss-cn-beijing.aliyuncs.com/c9de359d-888f-4bfd-8094-579e9c077c53.png)



##### double-checked locking é—®é¢˜ 

ä»¥è‘—åçš„ **double-checked locking å•ä¾‹**æ¨¡å¼ä¸ºä¾‹

```java
public final class Singleton {
    private Singleton() { }
    private static Singleton INSTANCE = null;
    public static Singleton getInstance() { 
        if(INSTANCE == null) { // t2
            // é¦–æ¬¡è®¿é—®ä¼šåŒæ­¥ï¼Œè€Œä¹‹åçš„ä½¿ç”¨æ²¡æœ‰ synchronized
            synchronized(Singleton.class) {
                if (INSTANCE == null) { // t1
                    INSTANCE = new Singleton();
                } 
            }
        }
        return INSTANCE;
    }
}
```

ä»¥ä¸Šçš„å®ç°ç‰¹ç‚¹æ˜¯ï¼š 

- **æ‡’æƒ°å®ä¾‹åŒ–** 
- **é¦–æ¬¡ä½¿ç”¨** getInstance() **æ‰ä½¿ç”¨ synchronized åŠ é”**ï¼Œåç»­ä½¿ç”¨æ—¶æ— éœ€åŠ é” 
- æœ‰éšå«çš„ï¼Œä½†å¾ˆå…³é”®çš„ä¸€ç‚¹ï¼š**ç¬¬ä¸€ä¸ª if ä½¿ç”¨äº† INSTANCE å˜é‡ï¼Œæ˜¯åœ¨åŒæ­¥å—ä¹‹å¤–**

ä½†åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œä¸Šé¢çš„ä»£ç æ˜¯æœ‰é—®é¢˜çš„ï¼ŒgetInstance æ–¹æ³•å¯¹åº”çš„å­—èŠ‚ç ä¸ºï¼š

```sh
0: getstatic #2 // Field INSTANCE:Lcn/itcast/n5/Singleton;
3: ifnonnull 37
6: ldc #3 // class cn/itcast/n5/Singleton
8: dup
9: astore_0
10: monitorenter
11: getstatic #2 // Field INSTANCE:Lcn/itcast/n5/Singleton;
14: ifnonnull 27
17: new #3 // class cn/itcast/n5/Singleton
20: dup
21: invokespecial #4 // Method "<init>":()V
24: putstatic #2 // Field INSTANCE:Lcn/itcast/n5/Singleton;
27: aload_0
28: monitorexit
29: goto 37
32: astore_1
33: aload_0
34: monitorexit
35: aload_1
36: athrow
37: getstatic #2 // Field INSTANCE:Lcn/itcast/n5/Singleton;
40: areturn
```

å…¶ä¸­ 

- 17 è¡¨ç¤ºåˆ›å»ºå¯¹è±¡ï¼Œå°†å¯¹è±¡å¼•ç”¨å…¥æ ˆ // new Singleton 
- 20 è¡¨ç¤ºå¤åˆ¶ä¸€ä»½å¯¹è±¡å¼•ç”¨ // å¼•ç”¨åœ°å€ 
- 21 è¡¨ç¤ºåˆ©ç”¨ä¸€ä¸ªå¯¹è±¡å¼•ç”¨ï¼Œè°ƒç”¨æ„é€ æ–¹æ³• 
- 24 è¡¨ç¤ºåˆ©ç”¨ä¸€ä¸ªå¯¹è±¡å¼•ç”¨ï¼Œèµ‹å€¼ç»™ static INSTANCE 

ä¹Ÿè®¸ jvm ä¼šä¼˜åŒ–ä¸ºï¼šå…ˆæ‰§è¡Œ 24ï¼Œå†æ‰§è¡Œ 21ã€‚å¦‚æœä¸¤ä¸ªçº¿ç¨‹ t1ï¼Œt2 æŒ‰å¦‚ä¸‹æ—¶é—´åºåˆ—æ‰§è¡Œï¼š

![image-20220307202619811](https://typora---------image.oss-cn-beijing.aliyuncs.com/208e5323-1eb8-493a-aceb-81704f8c4cf5.png)

å…³é”®åœ¨äº 0: getstatic è¿™è¡Œä»£ç åœ¨ monitor æ§åˆ¶ä¹‹å¤–ï¼Œå®ƒå°±åƒä¹‹å‰ä¸¾ä¾‹ä¸­ä¸å®ˆè§„åˆ™çš„äººï¼Œå¯ä»¥**è¶Šè¿‡ monitor è¯»å– INSTANCE å˜é‡çš„å€¼** 

è¿™æ—¶ t1 è¿˜**æœªå®Œå…¨å°†æ„é€ æ–¹æ³•æ‰§è¡Œå®Œæ¯•**ï¼Œå¦‚æœåœ¨æ„é€ æ–¹æ³•ä¸­è¦æ‰§è¡Œå¾ˆå¤šåˆå§‹åŒ–æ“ä½œï¼Œé‚£ä¹ˆ t2 æ‹¿åˆ°çš„æ˜¯å°†æ˜¯ä¸€ä¸ª**æœªåˆ å§‹åŒ–å®Œæ¯•çš„å•ä¾‹** 

å¯¹ INSTANCE **ä½¿ç”¨ volatile ä¿®é¥°**å³å¯ï¼Œå¯ä»¥**ç¦ç”¨æŒ‡ä»¤é‡æ’**ï¼Œä½†è¦æ³¨æ„åœ¨ JDK 5 ä»¥ä¸Šçš„ç‰ˆæœ¬çš„ volatile æ‰ä¼šçœŸæ­£æœ‰æ•ˆ



- synchronized **ä¸èƒ½é˜»æ­¢å†…éƒ¨ä»£ç å‘ç”Ÿé‡æ’åº**ï¼Œä½†æ˜¯åªè¦æ˜¯è¢«synchronizedå®Œå…¨ä¿æŠ¤èµ·æ¥çš„å˜é‡ï¼Œä¸ä¼šå‘ç”Ÿ**åŸå­æ€§ï¼Œå¯è§æ€§ï¼Œæœ‰åºæ€§é—®é¢˜**

- ç”±äº**å¤–éƒ¨å¯¹å˜é‡çš„è®¿é—®** å’Œ synchronized**å†…éƒ¨é‡æ’åºçš„ä¸­é—´è¿‡ç¨‹**çš„å…±åŒä½œç”¨æ‰é€ æˆè¿™ä¸ªç»“æœ
- è¿™é‡Œå°±æ˜¯ä¸€ä¸ªè·å¾—é”çš„çº¿ç¨‹ synchronizedå†…éƒ¨å…ˆæ‰§è¡Œäº†èµ‹å€¼ï¼Œåœ¨æ„é€ æ–¹æ³•æ‰§è¡Œä¹‹å‰ï¼Œä¸€ä¸ªçº¿ç¨‹å‘ç°äº†å¯¹è±¡ä¸ä¸ºnullï¼Œç›´æ¥è¿”å›äº†

##### double-checked locking è§£å†³



```java
public final class Singleton {
    private Singleton() { }
    private static volatile Singleton INSTANCE = null;
    public static Singleton getInstance() {
        // å®ä¾‹æ²¡åˆ›å»ºï¼Œæ‰ä¼šè¿›å…¥å†…éƒ¨çš„ synchronizedä»£ç å—
        if (INSTANCE == null) { 
            synchronized (Singleton.class) { // t2
                // ä¹Ÿè®¸æœ‰å…¶å®ƒçº¿ç¨‹å·²ç»åˆ›å»ºå®ä¾‹ï¼Œæ‰€ä»¥å†åˆ¤æ–­ä¸€æ¬¡
                if (INSTANCE == null) { // t1
                    INSTANCE = new Singleton();
                }
            }
        }
        return INSTANCE;
    }
}
```

å­—èŠ‚ç ä¸Šçœ‹ä¸å‡ºæ¥ volatile æŒ‡ä»¤çš„æ•ˆæœ

```sh
// -------------------------------------> åŠ å…¥å¯¹ INSTANCE å˜é‡çš„è¯»å±éšœ
0: getstatic #2 // Field INSTANCE:Lcn/itcast/n5/Singleton;
3: ifnonnull 37
6: ldc #3 // class cn/itcast/n5/Singleton
8: dup
9: astore_0
10: monitorenter -----------------------> ä¿è¯åŸå­æ€§ã€å¯è§æ€§
11: getstatic #2 // Field INSTANCE:Lcn/itcast/n5/Singleton;
14: ifnonnull 27
17: new #3 // class cn/itcast/n5/Singleton
20: dup
21: invokespecial #4 // Method "<init>":()V
24: putstatic #2 // Field INSTANCE:Lcn/itcast/n5/Singleton;
// -------------------------------------> åŠ å…¥å¯¹ INSTANCE å˜é‡çš„å†™å±éšœ
27: aload_0
28: monitorexit ------------------------> ä¿è¯åŸå­æ€§ã€å¯è§æ€§
29: goto 37
32: astore_1
33: aload_0
34: monitorexit
35: aload_1
36: athrow
37: getstatic #2 // Field INSTANCE:Lcn/itcast/n5/Singleton;
40: areturn
```

å¦‚ä¸Šé¢çš„æ³¨é‡Šå†…å®¹æ‰€ç¤ºï¼Œè¯»å†™ volatile å˜é‡æ—¶ä¼šåŠ å…¥å†…å­˜å±éšœï¼ˆMemory Barrierï¼ˆMemory Fenceï¼‰ï¼‰ï¼Œä¿è¯ä¸‹é¢ ä¸¤ç‚¹ï¼š

- å¯è§æ€§ 
  - å†™å±éšœï¼ˆsfenceï¼‰ä¿è¯åœ¨è¯¥å±éšœä¹‹å‰çš„ t1 å¯¹å…±äº«å˜é‡çš„æ”¹åŠ¨ï¼Œéƒ½åŒæ­¥åˆ°ä¸»å­˜å½“ä¸­ 
  - è€Œè¯»å±éšœï¼ˆlfenceï¼‰ä¿è¯åœ¨è¯¥å±éšœä¹‹å t2 å¯¹å…±äº«å˜é‡çš„è¯»å–ï¼ŒåŠ è½½çš„æ˜¯ä¸»å­˜ä¸­æœ€æ–°æ•°æ® 
- æœ‰åºæ€§ 
  - **å†™å±éšœä¼šç¡®ä¿æŒ‡ä»¤é‡æ’åºæ—¶ï¼Œä¸ä¼šå°†å†™å±éšœä¹‹å‰çš„ä»£ç æ’åœ¨å†™å±éšœä¹‹å** 
  - è¯»å±éšœä¼šç¡®ä¿æŒ‡ä»¤é‡æ’åºæ—¶ï¼Œä¸ä¼šå°†è¯»å±éšœä¹‹åçš„ä»£ç æ’åœ¨è¯»å±éšœä¹‹å‰ 
- æ›´åº•å±‚æ˜¯è¯»å†™å˜é‡æ—¶**ä½¿ç”¨ lock æŒ‡ä»¤**æ¥å¤šæ ¸ CPU ä¹‹é—´çš„**å¯è§æ€§ä¸æœ‰åºæ€§**

![image-20220307204740517](https://typora---------image.oss-cn-beijing.aliyuncs.com/5ef0df88-a054-4320-a7d1-368793489e93.png)



#### happens-before 



**happens-before** è§„å®šäº†**å¯¹å…±äº«å˜é‡çš„å†™æ“ä½œå¯¹å…¶å®ƒçº¿ç¨‹çš„è¯»æ“ä½œå¯è§**ï¼Œå®ƒæ˜¯å¯è§æ€§ä¸æœ‰åºæ€§çš„ä¸€å¥—**è§„åˆ™æ€»ç»“**ï¼ŒæŠ› å¼€ä»¥ä¸‹ happens-before è§„åˆ™ï¼ŒJMM å¹¶ä¸èƒ½ä¿è¯ä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡çš„å†™ï¼Œå¯¹äºå…¶å®ƒçº¿ç¨‹å¯¹è¯¥å…±äº«å˜é‡çš„è¯»å¯è§ 

- çº¿ç¨‹è§£é” m ä¹‹å‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹äºæ¥ä¸‹æ¥å¯¹ m åŠ é”çš„å…¶å®ƒçº¿ç¨‹å¯¹è¯¥å˜é‡çš„è¯»å¯è§(synchronizedå…³é”®å­—çš„å¯è§æ€§ã€ç›‘è§†å™¨è§„åˆ™)

  ```java
  static int x;
  static Object m = new Object();
  new Thread(()->{
      synchronized(m) {
          x = 10;
      }
  },"t1").start();
  new Thread(()->{
      synchronized(m) {
          System.out.println(x);
      }
  },"t2").start();
  ```

- çº¿ç¨‹å¯¹ volatile å˜é‡çš„å†™ï¼Œå¯¹æ¥ä¸‹æ¥å…¶å®ƒçº¿ç¨‹å¯¹è¯¥å˜é‡çš„è¯»å¯è§(volatileå…³é”®å­—çš„å¯è§æ€§ã€volatileè§„åˆ™)

  ```java
  volatile static int x;
  new Thread(()->{
      x = 10;
  },"t1").start();
  new Thread(()->{
      System.out.println(x);
  },"t2").start();
  ```

- çº¿ç¨‹ start å‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹è¯¥çº¿ç¨‹å¼€å§‹åå¯¹è¯¥å˜é‡çš„è¯»å¯è§(ç¨‹åºé¡ºåºè§„åˆ™+çº¿ç¨‹å¯åŠ¨è§„åˆ™)

  ```java
  static int x;
  x = 10;
  new Thread(()->{
      System.out.println(x);
  },"t2").start();
  ```

- çº¿ç¨‹ç»“æŸå‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹å…¶å®ƒçº¿ç¨‹å¾—çŸ¥å®ƒç»“æŸåçš„è¯»å¯è§ï¼ˆæ¯”å¦‚å…¶å®ƒçº¿ç¨‹è°ƒç”¨ t1.isAlive() æˆ– t1.join()ç­‰å¾… å®ƒç»“æŸï¼‰(çº¿ç¨‹ç»ˆæ­¢è§„åˆ™)

  ```java
  static int x;
  Thread t1 = new Thread(()->{
      x = 10;
  },"t1");
  t1.start();
  t1.join();
  System.out.println(x);
  ```

- çº¿ç¨‹ t1 æ‰“æ–­ t2ï¼ˆinterruptï¼‰å‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹äºå…¶ä»–çº¿ç¨‹å¾—çŸ¥ t2 è¢«æ‰“æ–­åå¯¹å˜é‡çš„è¯»å¯è§ï¼ˆé€šè¿‡ t2.interrupted æˆ– t2.isInterruptedï¼‰ï¼ˆçº¿ç¨‹ä¸­æ–­æœºåˆ¶ï¼‰

  ```java
  static int x;
  public static void main(String[] args) {
      Thread t2 = new Thread(()->{
          while(true) {
              if(Thread.currentThread().isInterrupted()) {
                  System.out.println(x);
                  break;
              }
          }
      },"t2");
      t2.start();
      new Thread(()->{
          sleep(1);
          x = 10;
          t2.interrupt();
      },"t1").start();
      while(!t2.isInterrupted()) {
          Thread.yield();
      }
      System.out.println(x);
  }
  ```

- å¯¹å˜é‡é»˜è®¤å€¼ï¼ˆ0ï¼Œfalseï¼Œnullï¼‰çš„å†™ï¼Œå¯¹å…¶å®ƒçº¿ç¨‹å¯¹è¯¥å˜é‡çš„è¯»å¯è§ 

- å…·æœ‰ä¼ é€’æ€§ï¼Œå¦‚æœ `x hb-> y` å¹¶ä¸” `y hb-> z` é‚£ä¹ˆæœ‰ `x hb-> z` ï¼Œé…åˆ volatile çš„é˜²æŒ‡ä»¤é‡æ’ï¼Œæœ‰ä¸‹é¢çš„ä¾‹å­

  ```java
  volatile static int x;
  static int y;
  new Thread(()->{ 
      y = 10;
      x = 20;
  },"t1").start();
  new Thread(()->{
      // x=20 å¯¹ t2 å¯è§, åŒæ—¶ y=10 ä¹Ÿå¯¹ t2 å¯è§
      System.out.println(x); 
  },"t2").start();
  ```

  > å˜é‡éƒ½æ˜¯æŒ‡æˆå‘˜å˜é‡æˆ–é™æ€æˆå‘˜å˜é‡ 
  >
  > å‚è€ƒï¼š ç¬¬17é¡µ
  >
  > åœ¨JMMä¸­æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„æ¦‚å¿µå¯¹äºæˆ‘ä»¬äº†è§£JMMæœ‰å¾ˆå¤§çš„å¸®åŠ©ï¼Œé‚£å°±æ˜¯happens-beforeè§„åˆ™ã€‚happens-beforeè§„åˆ™éå¸¸é‡è¦ï¼Œå®ƒæ˜¯**åˆ¤æ–­æ•°æ®æ˜¯å¦å­˜åœ¨ç«äº‰ã€çº¿ç¨‹æ˜¯å¦å®‰å…¨çš„ä¸»è¦ä¾æ®**ã€‚JSR-133Sä½¿ç”¨happens-beforeæ¦‚å¿µé˜è¿°äº†ä¸¤ä¸ªæ“ä½œä¹‹é—´çš„å†…å­˜å¯è§æ€§ã€‚åœ¨JMMä¸­ï¼Œå¦‚æœä¸€ä¸ªæ“ä½œçš„ç»“æœéœ€è¦å¯¹å¦ä¸€ä¸ªæ“ä½œå¯è§ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªæ“ä½œåˆ™å­˜åœ¨happens-beforeå…³ç³»ã€‚
  >
  > é‚£ä»€ä¹ˆæ˜¯happens-beforeå‘¢ï¼Ÿåœ¨JSR-133ä¸­ï¼Œhappens-beforeå…³ç³»å®šä¹‰å¦‚ä¸‹ï¼š
  >
  > 1. å¦‚æœ**ä¸€ä¸ªæ“ä½œhappens-beforeå¦ä¸€ä¸ªæ“ä½œ**ï¼Œé‚£ä¹ˆ**æ„å‘³ç€ç¬¬ä¸€ä¸ªæ“ä½œçš„ç»“æœå¯¹ç¬¬äºŒä¸ªæ“ä½œå¯**è§ï¼Œè€Œä¸”ç¬¬ä¸€ä¸ªæ“ä½œçš„æ‰§è¡Œé¡ºåºå°†æ’åœ¨ç¬¬äºŒä¸ªæ“ä½œçš„å‰é¢ã€‚
  > 2. ä¸¤ä¸ªæ“ä½œä¹‹é—´å­˜åœ¨happens-beforeå…³ç³»ï¼Œå¹¶**ä¸æ„å‘³ç€Javaå¹³å°çš„å…·ä½“å®ç°å¿…é¡»æŒ‰ç…§happens-beforeå…³ç³»æŒ‡å®šçš„é¡ºåºæ¥æ‰§è¡Œ**ã€‚å¦‚æœé‡æ’åºä¹‹åçš„ç»“æœï¼Œä¸æŒ‰ç…§happens-beforeå…³ç³»æ¥æ‰§è¡Œçš„ç»“æœä¸€è‡´ï¼Œé‚£ä¹ˆ**è¿™ç§é‡æ’åºå¹¶ä¸éæ³•**ï¼ˆä¹Ÿå°±æ˜¯è¯´ï¼Œ**JMMå…è®¸è¿™ç§é‡æ’åº**ï¼‰
  >
  > happens-beforeè§„åˆ™å¦‚ä¸‹ï¼š
  >
  > 1. ç¨‹åºé¡ºåºè§„åˆ™ï¼šä¸€ä¸ªçº¿ç¨‹ä¸­çš„æ¯ä¸€ä¸ªæ“ä½œï¼Œhappens-beforeäºè¯¥çº¿ç¨‹ä¸­çš„ä»»æ„åç»­æ“ä½œã€‚
  > 2. ç›‘è§†å™¨è§„åˆ™ï¼šå¯¹ä¸€ä¸ªé”çš„è§£é”ï¼Œhappens-beforeäºéšåå¯¹è¿™ä¸ªé”çš„åŠ é”ã€‚
  > 3. volatileè§„åˆ™ï¼šå¯¹ä¸€ä¸ªvolatileå˜é‡çš„å†™ï¼Œhappens-beforeäºä»»æ„åç»­å¯¹ä¸€ä¸ªvolatileå˜é‡çš„è¯»ã€‚
  > 4. ä¼ é€’æ€§ï¼šè‹¥æœA happens-before Bï¼ŒB happens-before Cï¼Œé‚£ä¹ˆA happens-before Cã€‚
  > 5. çº¿ç¨‹å¯åŠ¨è§„åˆ™ï¼šThreadå¯¹è±¡çš„start()æ–¹æ³•ï¼Œhappens-beforeäºè¿™ä¸ªçº¿ç¨‹çš„ä»»æ„åç»­æ“ä½œã€‚
  > 6. çº¿ç¨‹ç»ˆæ­¢è§„åˆ™ï¼šçº¿ç¨‹ä¸­çš„ä»»æ„æ“ä½œï¼Œhappens-beforeäºè¯¥çº¿ç¨‹çš„ç»ˆæ­¢ç›‘æµ‹ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡Thread.join()æ–¹æ³•ç»“æŸã€Thread.isAlive()çš„è¿”å›å€¼ç­‰æ‰‹æ®µæ£€æµ‹åˆ°çº¿ç¨‹å·²ç»ç»ˆæ­¢æ‰§è¡Œã€‚
  > 7. çº¿ç¨‹ä¸­æ–­æ“ä½œï¼šå¯¹çº¿ç¨‹interrupt()æ–¹æ³•çš„è°ƒç”¨ï¼Œhappens-beforeäºè¢«ä¸­æ–­çº¿ç¨‹çš„ä»£ç æ£€æµ‹åˆ°ä¸­æ–­äº‹ä»¶çš„å‘ç”Ÿï¼Œå¯ä»¥é€šè¿‡Thread.interrupted()æ–¹æ³•æ£€æµ‹åˆ°çº¿ç¨‹æ˜¯å¦æœ‰ä¸­æ–­å‘ç”Ÿã€‚
  > 8. å¯¹è±¡ç»ˆç»“è§„åˆ™ï¼šä¸€ä¸ªå¯¹è±¡çš„åˆå§‹åŒ–å®Œæˆï¼Œhappens-beforeäºè¿™ä¸ªå¯¹è±¡çš„finalize()æ–¹æ³•çš„å¼€å§‹ã€‚
  >
  > å‚è€ƒé“¾æ¥ï¼š[happens-beforeè§„åˆ™è§£æ - çŸ¥ä¹ (zhihu.com)](https://zhuanlan.zhihu.com/p/77157725)



#### ä¹ é¢˜



##### balking æ¨¡å¼ä¹ é¢˜ 

å¸Œæœ› doInit() æ–¹æ³•ä»…è¢«è°ƒç”¨ä¸€æ¬¡ï¼Œä¸‹é¢çš„å®ç°æ˜¯æœ‰é—®é¢˜

æ²¡æœ‰ä¿è¯init æ–¹æ³•çš„åŸå­æ€§ï¼Œä»…ä»…ä¿è¯äº†å˜é‡çš„å¯è§æ€§

```java
public class TestVolatile {
    volatile boolean initialized = false;
    void init() {
        if (initialized) { 
            return;
        } 
        doInit();
        initialized = true;
    }
    private void doInit() {
    }
} 
```



##### çº¿ç¨‹å®‰å…¨å•ä¾‹ä¹ é¢˜ 

å•ä¾‹æ¨¡å¼æœ‰å¾ˆå¤šå®ç°æ–¹æ³•ï¼Œ**é¥¿æ±‰ã€æ‡’æ±‰ã€é™æ€å†…éƒ¨ç±»ã€æšä¸¾ç±»**ï¼Œè¯•åˆ†ææ¯ç§å®ç°ä¸‹è·å–å•ä¾‹å¯¹è±¡ï¼ˆå³è°ƒç”¨ getInstanceï¼‰æ—¶çš„çº¿ç¨‹å®‰å…¨ï¼Œå¹¶æ€è€ƒæ³¨é‡Šä¸­çš„é—®é¢˜

> **é¥¿æ±‰å¼**ï¼š**ç±»åŠ è½½å°±ä¼šå¯¼è‡´è¯¥å•å®ä¾‹å¯¹è±¡è¢«åˆ›å»º** 
>
> **æ‡’æ±‰å¼**ï¼šç±»åŠ è½½ä¸ä¼šå¯¼è‡´è¯¥å•å®ä¾‹å¯¹è±¡è¢«åˆ›å»ºï¼Œè€Œæ˜¯**é¦–æ¬¡ä½¿ç”¨è¯¥å¯¹è±¡æ—¶æ‰ä¼šåˆ›å»º**



**å®ç°1(é¥¿æ±‰å¼)ï¼š**

```java
// é—®é¢˜1ï¼šä¸ºä»€ä¹ˆåŠ  final(é˜²æ­¢è¢«å­ç±»ç»§æ‰¿ä»è€Œé‡å†™æ–¹æ³•æ”¹å†™å•ä¾‹)
// é—®é¢˜2ï¼šå¦‚æœå®ç°äº†åºåˆ—åŒ–æ¥å£, è¿˜è¦åšä»€ä¹ˆæ¥é˜²æ­¢ååºåˆ—åŒ–ç ´åå•ä¾‹(é‡å†™readResolveæ–¹æ³•)
public final class Singleton implements Serializable {
    // é—®é¢˜3ï¼šä¸ºä»€ä¹ˆè®¾ç½®ä¸ºç§æœ‰? æ˜¯å¦èƒ½é˜²æ­¢åå°„åˆ›å»ºæ–°çš„å®ä¾‹?(é˜²æ­¢å¤–éƒ¨è°ƒç”¨æ„é€ æ–¹æ³•åˆ›å»ºå¤šä¸ªå®ä¾‹ï¼›ä¸èƒ½)
    private Singleton() {}
    // é—®é¢˜4ï¼šè¿™æ ·åˆå§‹åŒ–æ˜¯å¦èƒ½ä¿è¯å•ä¾‹å¯¹è±¡åˆ›å»ºæ—¶çš„çº¿ç¨‹å®‰å…¨?(èƒ½ï¼Œçº¿ç¨‹å®‰å…¨æ€§ç”±ç±»åŠ è½½å™¨ä¿éšœï¼Œç±»åŠ è½½é˜¶æ®µ)
    private static final Singleton INSTANCE = new Singleton();
    // é—®é¢˜5ï¼šä¸ºä»€ä¹ˆæä¾›é™æ€æ–¹æ³•è€Œä¸æ˜¯ç›´æ¥å°† INSTANCE è®¾ç½®ä¸º public, è¯´å‡ºä½ çŸ¥é“çš„ç†ç”±(å¯ä»¥ä¿è¯instanceçš„å®‰å…¨æ€§ï¼Œä¹Ÿèƒ½æ–¹ä¾¿å®ç°ä¸€äº›é™„åŠ é€»è¾‘(å°è£…æ€§ï¼Œå¯ä»¥åšæ‡’åŠ è½½))
    public static Singleton getInstance() {
        return INSTANCE;
    }
    public Object readResolve() {
      // å®ç°Serializableæ¥å£ï¼Œå¯ä»¥é€šè¿‡ååºåˆ—åŒ–æ„é€ å¯¹è±¡ï¼Œå¯¼è‡´å•ä¾‹å¤±æ•ˆï¼Œé‡å†™è¿™ä¸ªObjectæ–¹æ³•ï¼Œæ˜¯çš„ååºåˆ—åŒ–ä¹Ÿè¿”å›åŒä¸€ä¸ªå•ä¾‹å¯¹è±¡	
        return INSTANCE;
    }
}
```



**å®ç°2(æšä¸¾ç±»)ï¼š**

```java
// é—®é¢˜1ï¼šæšä¸¾å•ä¾‹æ˜¯å¦‚ä½•é™åˆ¶å®ä¾‹ä¸ªæ•°çš„ (æšä¸¾ç±»ä¼šæŒ‰ç…§å£°æ˜çš„ä¸ªæ•°åœ¨ç±»åŠ è½½æ—¶å®ä¾‹åŒ–å¯¹è±¡)
// é—®é¢˜2ï¼šæšä¸¾å•ä¾‹åœ¨åˆ›å»ºæ—¶æ˜¯å¦æœ‰å¹¶å‘é—®é¢˜(æ²¡æœ‰ï¼Œç”±ç±»åŠ è½½å™¨ä¿éšœå®‰å…¨æ€§ï¼Œé™æ€æˆå‘˜å˜é‡)
// é—®é¢˜3ï¼šæšä¸¾å•ä¾‹èƒ½å¦è¢«åå°„ç ´åå•ä¾‹(ä¸èƒ½)
// é—®é¢˜4ï¼šæšä¸¾å•ä¾‹èƒ½å¦è¢«ååºåˆ—åŒ–ç ´åå•ä¾‹(ä¸èƒ½ , å®ç°åºåˆ—åŒ–æ¥å£ï¼Œé‡å†™äº†readObject æ–¹æ³•(æŠ›å‡ºå¼‚å¸¸))
// é—®é¢˜5ï¼šæšä¸¾å•ä¾‹å±äºæ‡’æ±‰å¼è¿˜æ˜¯é¥¿æ±‰å¼(é¥¿æ±‰,é™æ€æˆå‘˜å˜é‡ï¼Œç±»åŠ è½½åå°±åˆ›å»ºå®Œæˆ)
// é—®é¢˜6ï¼šæšä¸¾å•ä¾‹å¦‚æœå¸Œæœ›åŠ å…¥ä¸€äº›å•ä¾‹åˆ›å»ºæ—¶çš„åˆå§‹åŒ–é€»è¾‘è¯¥å¦‚ä½•åš(å†™æ„é€ æ–¹æ³•)
enum Singleton { 
    INSTANCE; 
}
```



**å®ç°3(synchronizedæ–¹æ³•)ï¼š**

```java
public final class Singleton {
    private Singleton() { }
    private static Singleton INSTANCE = null;
    // åˆ†æè¿™é‡Œçš„çº¿ç¨‹å®‰å…¨, å¹¶è¯´æ˜æœ‰ä»€ä¹ˆç¼ºç‚¹(æ²¡æœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼ŒåŒæ­¥ä»£ç å—ç²’åº¦å¤ªå¤§ï¼Œæ€§èƒ½å·®)
    public static synchronized Singleton getInstance() {
        if( INSTANCE != null ){
            return INSTANCE;
        } 
        INSTANCE = new Singleton();
        return INSTANCE;
    }
}
```



**å®ç°4ï¼šDCL+volatile**

```java
public final class Singleton {
    private Singleton() { }
    // é—®é¢˜1ï¼šè§£é‡Šä¸ºä»€ä¹ˆè¦åŠ  volatile ?(sychronized ä¸­ newå¯¹è±¡ èµ‹å€¼ å’Œ æ„é€ æ–¹æ³•å¯èƒ½å‘ç”Ÿé‡æ’åºï¼Œå…¶ä»–çº¿ç¨‹å¯èƒ½ä¼šåœ¨èµ‹å€¼å(æ„é€ æ–¹æ³•æ‰§è¡Œä¹‹å‰ï¼Œ å°±æŠŠinstanceè¿”å›äº†ï¼Œå°±å‡ºé—®é¢˜äº†))
    private static volatile Singleton INSTANCE = null;

    // é—®é¢˜2ï¼šå¯¹æ¯”å®ç°3, è¯´å‡ºè¿™æ ·åšçš„æ„ä¹‰ (ç¼©å°äº†é”çš„ç²’åº¦ï¼Œæé«˜äº†æ€§èƒ½ï¼Œè€Œä¸”ä¸ç”¨å¤šæ¬¡åŠ é”)
    public static Singleton getInstance() {
        if (INSTANCE != null) { 
            return INSTANCE;
        }
        synchronized (Singleton.class) { 
            // é—®é¢˜3ï¼šä¸ºä»€ä¹ˆè¿˜è¦åœ¨è¿™é‡ŒåŠ ä¸ºç©ºåˆ¤æ–­, ä¹‹å‰ä¸æ˜¯åˆ¤æ–­è¿‡äº†å—
            if (INSTANCE != null) { // é˜²æ­¢ç¬¬ä¸€æ¬¡ä½¿ç”¨çš„æ—¶å€™å¤šä¸ªçº¿ç¨‹åˆ°äº†è¿™ä¸€æ­¥ï¼Œä¸åŠ é”å°±æ¯ä¸ªçº¿ç¨‹éƒ½åˆ›å»ºäº†
                return INSTANCE;
            }
            INSTANCE = new Singleton(); 
            return INSTANCE;
        } 
    }
}
```



**å®ç°5(å†…éƒ¨ç±»åˆå§‹åŒ–)ï¼š**

```java
public final class Singleton {
    private Singleton() { }
    // é—®é¢˜1ï¼šå±äºæ‡’æ±‰å¼è¿˜æ˜¯é¥¿æ±‰å¼ - æ‡’æ±‰ï¼Œç±»æœ¬èº«å°±æ˜¯æ‡’åŠ è½½ï¼Œåˆ›å»ºå¤–éƒ¨ç±»ä¸ä¼šåˆå§‹åŒ–åŠ è½½å†…éƒ¨ç±»ï¼Œä¸ä¼šåˆ¶é€ å®ä¾‹
    private static class LazyHolder {
        static final Singleton INSTANCE = new Singleton();
    }
    // é—®é¢˜2ï¼šåœ¨åˆ›å»ºæ—¶æ˜¯å¦æœ‰å¹¶å‘é—®é¢˜
    public static Singleton getInstance() {
        return LazyHolder.INSTANCE;
    }
}
```



## æœ¬ç« å°ç»“ 

æœ¬ç« é‡ç‚¹è®²è§£äº† JMM ä¸­çš„ 

- å¯è§æ€§ - ç”± JVM ç¼“å­˜ä¼˜åŒ–å¼•èµ· 
- æœ‰åºæ€§ - ç”± JVM æŒ‡ä»¤é‡æ’åºä¼˜åŒ–å¼•èµ· 
- happens-before è§„åˆ™ 
- <font color='blue'>åŸç†æ–¹é¢</font>
  - CPU æŒ‡ä»¤å¹¶è¡Œ 
  - volatile 
- <font color='orange'>æ¨¡å¼æ–¹é¢ </font>
  - ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼çš„ volatile æ”¹è¿› 
  - åŒæ­¥æ¨¡å¼ä¹‹ balking